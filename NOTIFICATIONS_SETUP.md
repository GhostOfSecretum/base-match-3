# Настройка уведомлений от имени мини-аппки в Base app

Уведомления приходят пользователям **от имени вашей мини-аппки** (Base Match-3): в клиенте Farcaster (Base app / Warpcast) они отображаются с иконкой и названием вашего приложения.

## Что уже настроено

- **webhookUrl** в `.well-known/farcaster.json` указывает на `https://base-match-3.vercel.app/api/webhook` — Base app будет слать сюда события (подписка/отписка на уведомления).
- **api/webhook.js** принимает события и логирует их. Для полноценной рассылки нужно либо сохранять токены и слать уведомления самим, либо использовать Neynar.

## Как это устроено

1. Пользователь включает уведомления для вашей мини-аппки в Base app.
2. Клиент генерирует **notification token** и отправляет его на ваш `webhookUrl`.
3. Вы сохраняете токен (или используете Neynar, который делает это за вас).
4. Когда нужно отправить уведомление — вызываете API с этим токеном; уведомление показывается **от имени мини-аппки** (название и иконка из `farcaster.json`).

---

## Вариант 1: Neynar (рекомендуется)

Neynar хранит токены за вас и даёт API для отправки уведомлений.

### Шаги

1. **Регистрация в Neynar**
   - Зайдите на [neynar.com](https://neynar.com), создайте аккаунт.
   - В Dashboard создайте приложение и получите **API Key**.

2. **Привязка мини-аппки**
   - В Neynar укажите ваш **Mini App URL**: `https://base-match-3.vercel.app` (или домен, где доступен `farcaster.json`).
   - Убедитесь, что в `.well-known/farcaster.json` указан корректный `webhookUrl` — Neynar может использовать его для синхронизации токенов (см. их [документацию по App Host Notifications](https://docs.neynar.com/docs/app-host-notifications)).

3. **Отправка уведомлений**
   - Используйте Neynar API:
     - [Список токенов](https://docs.neynar.com/reference/fetch-notification-tokens) — получить токены пользователей вашей мини-аппки.
     - Отправка уведомления — по их API (title, body, target FID или token).
   - В запросе передаёте заголовок/тело; от имени какой мини-аппки показывать уведомление определяется по токену/приложению в Neynar.

4. **Документация**
   - [Base: Send Notifications (Neynar)](https://docs.base.org/mini-apps/technical-guides/neynar-notifications)
   - [Neynar: Mini App Host Notifications](https://docs.neynar.com/docs/app-host-notifications)
   - [Neynar: fetch notification tokens](https://docs.neynar.com/reference/fetch-notification-tokens)

---

## Вариант 2: Свой сервер (self-hosted)

Вы сами принимаете webhook, сохраняете токены и потом отправляете уведомления.

### 1. Webhook уже есть

`api/webhook.js` принимает события. Нужно обрабатывать события с **токеном** и сохранять его в БД.

Типичные типы событий:

- `notification_enabled` — пользователь включил уведомления; в `event.data` приходит токен (и часто `fid`, `url` и т.п.).
- `notification_disabled` — пользователь выключил уведомления; соответствующий токен нужно пометить недействительным или удалить.

Формат `event.data` зависит от клиента (Base app / Warpcast). Обычно там есть:

- идентификатор пользователя (например, `fid`);
- токен или URL для отправки уведомления.

Сохраняйте в БД: `fid`, токен/URL, статус (enabled/disabled), дату.

### 2. Отправка уведомления

Как именно отправлять запрос с токеном, смотрите в актуальной спецификации Farcaster Mini Apps и документации клиента (Base/Warpcast). Обычно это POST на URL из webhook с телом (title, body, actionUrl и т.д.) и использованием сохранённого токена для авторизации.

Альтернатива: использовать Neynar только для **отправки**, а токены собирать своим webhook — если Neynar поддерживает передачу токена в запросе отправки (проверьте их API).

### 3. Безопасность

- Webhook должен быть по **HTTPS** (у вас уже так на Vercel).
- Проверяйте, что запросы действительно от Base/Farcaster (по возможности — подпись или источник), чтобы не принимать поддельные токены.
- Токены — секрет: хранить в безопасном хранилище, не логировать в открытом виде.

---

## Итог

| Действие | Где |
|----------|-----|
| Указать, куда слать события | `webhookUrl` в `.well-known/farcaster.json` ✅ |
| Принимать события | `api/webhook.js` ✅ |
| Хранить токены и слать уведомления | Neynar **или** свой бэкенд + БД |
| Отображение «от имени мини-аппки» | Автоматически по токену (привязан к вашей мини-аппке) |

Для быстрого старта лучше подключить Neynar и отправлять уведомления через их API; при необходимости потом можно перенести на свой сервер и свой webhook.

#!/bin/bash
# Pre-push hook Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¿ÐµÑ€ÐµÐ´ push

# Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ñ€ÐµÐºÑƒÑ€ÑÐ¸Ð¸
if [ "$SKIP_VERSION_BUMP" = "1" ]; then
    exit 0
fi

# ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
cd "$(git rev-parse --show-toplevel)" || exit 1

echo "ðŸ”„ Auto-updating version before push..."

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¸
node update-version.cjs

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð±Ñ‹Ð»Ð¸ Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
if git diff --quiet script.js package.json api/leaderboard.js index.html; then
    echo "â„¹ï¸  Version already up to date"
else
    echo "ðŸ“ Staging version changes..."
    git add script.js package.json api/leaderboard.js index.html
    
    echo "ðŸ’¾ Committing version bump..."
    git commit -m "chore: bump version [auto]" --no-verify
    
    echo "âœ… Version updated and committed"
    
    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð¼Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð²ÐµÑ‚ÐºÐ¸ Ð¸ remote
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
    REMOTE=$(git config branch.$BRANCH.remote || echo "origin")
    
    echo "ðŸš€ Pushing version bump commit..."
    SKIP_VERSION_BUMP=1 git push "$REMOTE" "$BRANCH" --no-verify
    
    # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ Ð²ÐµÑ‚ÐºÑƒ Ð¿Ð¾ÑÐ»Ðµ push
    git fetch "$REMOTE" "$BRANCH" 2>/dev/null || true
    git reset --hard "$REMOTE/$BRANCH" 2>/dev/null || true
fi

# ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ push
exit 0

#!/bin/bash

# Git hook Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¿ÐµÑ€ÐµÐ´ push
# Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°Ñ‚ÑŒ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¿Ñ€Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð¼ push

echo "ðŸ”„ Auto-updating version before push..."

# ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
cd "$(git rev-parse --show-toplevel)" || exit 1

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Node.js Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
if ! command -v node &> /dev/null; then
    echo "âš ï¸  Node.js not found. Skipping version update."
    exit 0
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
if [ ! -f "update-version.js" ]; then
    echo "âš ï¸  update-version.js not found. Skipping version update."
    exit 0
fi

# Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð²ÐµÑ€ÑÐ¸Ð¸
git stash push -m "pre-push-version-update-stash" script.js package.json api/leaderboard.js 2>/dev/null || true

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¸
if node update-version.js; then
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð±Ñ‹Ð»Ð¸ Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ð²ÐµÑ€ÑÐ¸Ð¸
    if ! git diff --quiet --exit-code script.js package.json api/leaderboard.js 2>/dev/null; then
        echo "ðŸ“ Version files have been updated. Adding to commit..."
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð²ÐµÑ€ÑÐ¸Ð¸
        git add script.js package.json api/leaderboard.js
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸Ð¸
        git commit -m "chore: bump version [auto]" --no-verify || {
            echo "âš ï¸  Failed to commit version update. Continuing with push..."
        }
        
        echo "âœ… Version updated and committed automatically."
    else
        echo "â„¹ï¸  Version unchanged or already up to date."
        # Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ stashed Ñ„Ð°Ð¹Ð»Ñ‹, ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð±Ñ‹Ð»Ð¸
        git stash pop 2>/dev/null || true
    fi
else
    echo "âŒ Failed to update version. Continuing with push..."
    # Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ stashed Ñ„Ð°Ð¹Ð»Ñ‹ Ð² ÑÐ»ÑƒÑ‡Ð°Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
    git stash pop 2>/dev/null || true
fi

# ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ push
exit 0

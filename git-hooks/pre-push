#!/bin/bash
# Pre-push hook –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ –ø–µ—Ä–µ–¥ push

# –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏
if [ "$SKIP_VERSION_BUMP" = "1" ]; then
    exit 0
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
cd "$(git rev-parse --show-toplevel)" || exit 1

echo "üîÑ Auto-updating version before push..."

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏
node update-version.cjs

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
if git diff --quiet script.js package.json api/leaderboard.js index.html; then
    echo "‚ÑπÔ∏è  Version already up to date"
else
    echo "üìù Staging version changes..."
    git add script.js package.json api/leaderboard.js index.html
    
    echo "üíæ Committing version bump..."
    git commit -m "chore: bump version [auto]" --no-verify
    
    echo "‚úÖ Version updated and committed"
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ç–∫–∏ –∏ remote
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
    REMOTE=$(git config branch.$BRANCH.remote || echo "origin")
    
    echo "üöÄ Pushing version bump commit..."
    SKIP_VERSION_BUMP=1 git push "$REMOTE" "$BRANCH" --no-verify
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ remote –∏ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    git fetch "$REMOTE" "$BRANCH" 2>/dev/null || true
    git update-ref "refs/heads/$BRANCH" "$REMOTE/$BRANCH" 2>/dev/null || true
    git reset --hard "$REMOTE/$BRANCH" 2>/dev/null || true
    
    # –û—Ç–º–µ–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π push, —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    echo "‚úÖ All changes pushed, skipping main push"
    exit 0
fi

# –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º push
exit 0
